<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprungli - Technical Search</title>
    <link rel="stylesheet" href="https://fonts.bunny.net/css?family=orbitron:700|roboto:400,700|fira+code:400">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="dark-mode">

    <nav class="main-nav">
        <div class="container">
            <a href="index.html" class="nav-logo">Natalie Spiva</a>
            <ul class="nav-links">
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#projects">Projects</a></li>
                <li><a href="resume.html">Resume</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="index.html#accomplishments" id="accomplishments-btn">Accomplishments</a></li>
                <li><a href="index.html#more-about-me" id="more-about-me-btn">More About Me</a></li>
            </ul>
            <div class="theme-switcher">
                <button data-theme="dark-mode" class="active">Dark</button>
                <button data-theme="light-mode">Light</button>
                <button data-theme="assisted-reading-mode">Assisted</button>
            </div>
        </div>
    </nav>

    <div id="app" v-cloak class="container">
        <main class="search-wrapper">
            <h1 class="section-title">Sprungli Technical Search</h1>
            
            <form class="search-form" @submit.prevent="performSearch">
                <input type="text" id="searchInput" placeholder="Search Arch, Gentoo, and Microsoft Docs..." autocomplete="off" v-model="searchQuery">
                <button type="submit" id="searchButton" aria-label="Submit search">
                    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" style="width:20px;height:20px; color: white;"><path d="M16.67 16.64L21 21M19 11c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8 8 3.58 8 8Z"/></svg>
                </button>
            </form>
            
            <div class="results-wrapper">
                <div v-if="isLoading" class="notice">Searching...</div>
                
                <template v-else-if="results.length > 0">
                    <div v-for="(result, index) in results" :key="result.pageid + result.sourceKey" class="result-item" :style="{animationDelay: index * 40 + 'ms'}">
                        <div class="result-header">
                            <span class="result-source-tag" :style="{ backgroundColor: SOURCES[result.sourceKey].color }">{{ SOURCES[result.sourceKey].name }}</span>
                        </div>
                        <h3 class="result-title"><a :href="result.pageUrl" target="_blank" rel="noopener noreferrer" class="result-title-link">{{ result.title }}</a></h3>
                        <div class="result-snippet" v-html="result.snippet"></div>
                    </div>
                </template>
                
                <div v-else-if="infoMessage" class="notice" v-html="infoMessage"></div>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
    const { createApp, ref, computed, watch } = Vue;

    createApp({
        setup() {
            // --- DATA SOURCES ---
            const SOURCES = {
                arch: { name: 'Arch Wiki', type: 'wiki', api: 'https://wiki.archlinux.org/api.php', color: '#1793D1' },
                gentoo: { name: 'Gentoo Wiki', type: 'wiki', api: 'https://wiki.gentoo.org/api.php', color: '#9681C0' },
                microsoft: { name: 'Microsoft Docs', type: 'external', searchDomain: 'learn.microsoft.com', color: '#0078D4' }
            };

            // --- STATE MANAGEMENT ---
            const searchQuery = ref('');
            const results = ref([]);
            const isLoading = ref(false);
            const hasSearched = ref(false);
            let debounceTimer = null;

            // --- COMPUTED PROPERTIES ---
            const wikiSources = computed(() => Object.entries(SOURCES).filter(([_, s]) => s.type === 'wiki').map(([key, val]) => ({ key, ...val })));
            const infoMessage = computed(() => {
                if (!hasSearched.value) return 'Enter a query to begin.';
                if (results.value.length === 0) return `No results found for '<span class="notice-query">${searchQuery.value}</span>' in Arch or Gentoo wikis.`;
                return '';
            });

            // --- METHODS ---
            const fetchWikiResults = async (source, query) => {
                const url = `${source.api}?action=query&list=search&srsearch=${encodeURIComponent(query)}&srprop=snippet&format=json&origin=*`;
                try {
                    const response = await fetch(url, { signal: AbortSignal.timeout(8000) });
                    if (!response.ok) throw new Error(`API for ${source.name} failed.`);
                    const data = await response.json();
                    return (data.query?.search || []).map(result => ({ ...result, sourceKey: source.key, pageUrl: `${new URL(source.api).origin}/index.php?title=${encodeURIComponent(result.title)}` }));
                } catch (error) {
                    console.error(`Failed to fetch from ${source.name}:`, error);
                    return [];
                }
            };

            const performSearch = async () => {
                const query = searchQuery.value.trim();
                if (!query) {
                    results.value = [];
                    hasSearched.value = false;
                    return;
                }
                isLoading.value = true;
                hasSearched.value = true;
                results.value = [];

                const settledResults = await Promise.allSettled(wikiSources.value.map(s => fetchWikiResults(s, query)));
                let combinedResults = settledResults.flatMap(res => (res.status === 'fulfilled' ? res.value : []));
                combinedResults.sort((a, b) => (b.snippet.includes('searchmatch') ? 1 : 0) - (a.snippet.includes('searchmatch') ? 1 : 0));
                
                results.value = combinedResults;
                isLoading.value = false;
            };

            // --- WATCHER ---
            watch(searchQuery, (newQuery) => {
                clearTimeout(debounceTimer);
                if (newQuery.trim()) {
                    debounceTimer = setTimeout(performSearch, 500);
                } else {
                    results.value = [];
                    hasSearched.value = false;
                }
            });
            
            return {
                SOURCES, searchQuery, results, isLoading, hasSearched, infoMessage,
                performSearch
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
